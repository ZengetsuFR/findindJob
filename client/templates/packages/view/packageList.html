<template name="resultMetier">
 <span>{{metier}}</span>
</template>

<template name="packageList">
	<div id="barrerecherche">
	<form>
		<!--<input class="search" type="search" id="searchJob" placeholder="Rechercher par métier" >-->
		<div id="contentinput">
		    {{> inputAutocomplete settings=settings id="metier" class="form-control" name= "metier" autocomplete="off" onfocus="this.value = '';job=null;" placeholder="Rechercher par métier"}}
            <br>
            <label id="labelInfo" style="color:red"></label>
		    <div class="searchbtn">
                <button type="button" id="notification-trigger" class="progress-button bouton-bleu">
					<span id="libelleRechercher" class="content">Rechercher</span>
					<span class="progress"></span>
	            </button>
		    </div>
	    </div>
    </form>
    </div>

   <div>
     <script src="asset/js/classie.js"></script>
			<script src="asset/js/notificationFx.js"></script>
			<script>
				window.addEventListener("load", pageFullyLoaded, false);
				function pageFullyLoaded() {
					var bttn = document.getElementById( 'notification-trigger' );
					// make sure..
					bttn.disabled =false;
					bttn.addEventListener( 'click', function() {
						var textToShare = encodeURI("http://twitter.com/share?text=Pour mon futur métier " + libelleRome + " il existe actuellement " +  statRome + "% d'offres d'emploi")
						// simulate loading (for demo purposes only)
						classie.add( bttn, 'active' );
						setTimeout( function() {

							classie.remove( bttn, 'active' );

							var notification = new NotificationFx({
								message : '<h3>' + libelleRome + '</h3> <div id="secteur-data">' + statRome +'</div> <div id="secteur-description">' + libellePopin + '</div>' +
								          '<a href='+ textToShare + ' class="bouton-bleu secteur-bouton">Partager sur twitter</a>' +
													'<a href="http://www.facebook.com/share.php?u=www.monfuturmetier.com" class="bouton-bleu secteur-bouton">Partager sur Facebook</a>',
													/*'<a href="#" class="bouton-rose secteur-bouton">Effectuer une autre recherche</a>',*/
								layout : 'growl',
								effect : 'jelly',
								type : 'notice', // notice, warning, error or success
                                ttl : 6000,
								onClose : function() {
									bttn.disabled = false;
								}
							});

							// show the notification
							notification.show();

						}, 1200 );

						// disable the button (for demo purposes only)
						this.disabled = false;
					});
                }
                 var urlParams = new URLSearchParams(window.location.search);
                 var job = urlParams.get("job");
                 var codeMetier = urlParams.get("code");
                 document.getElementById("metier").value = job;
                 romeCode = codeMetier;
                 callGetStatForRome = function(){
                    Meteor.call("getStatForRome", romeCode, function (err, response) {
                     if (err){
                        document.getElementById("labelInfo").innerHTML = "pas de données statistiques pour ce métier";
                        document.getElementById("notification-trigger").disabled = true;
                     }else{
                        document.getElementById("labelInfo").innerHTML = "";
                        var stats = response.result.records[0].NB_OFFER_END_MONTH*100/response.result.records[0].NB_APPLICATION_END_MONTH;
                        stats = stats.toFixed(2);
                        breakpoint(stats);
                        nboffre = "( soit " + response.result.records[0].NB_OFFER_END_MONTH + " offres)";
                        Session.set("StatsForRome",stats);
                        var sel = document.getElementById('metier');
                        pos = sel.value.indexOf('/')>0 ? sel.value.indexOf('/'):sel.length;

                        libelleRome = sel.value.substring(0, pos);
                        libellePopin = "LE MARCHÉ EST " + wordingLibellePopin + " AVEC " + response.result.records[0].NB_APPLICATION_END_MONTH + " DEMANDEURS D'EMPLOIS" +
                                        " POUR " + response.result.records[0].NB_OFFER_END_MONTH + " POSTES DISPONIBLES"

                        statRome = wordingRome;
                        document.getElementById("notification-trigger").click();
                     }
                    });
                 }
                if (job){
                     callGetStatForRome();
                    /*setTimeout(function(){
                        document.getElementById("notification-trigger").click();
                    },2000);*/
                }
			</script>
   </div>
  <!--
  <div class="posts">
    <select id="packageId" name="packageId">
      {{#each packages}}
       <option value="{{id}}">{{title}}</option>
      {{/each}}
    </select>
  </div>
  </form>
  <div class="posts">
    {{#if resources}}
    <select id="resourceId" name="resourceId">
      {{#each resources}}
       <option value="{{id}}">{{description}}</option>
      {{/each}}
    </select>
    {{/if}}
    -->

</template>